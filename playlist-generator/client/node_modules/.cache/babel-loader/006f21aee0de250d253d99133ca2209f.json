{"ast":null,"code":"var express = require(\"express\");\n\nvar logger = require(\"morgan\");\n\nvar mongoose = require(\"mongoose\"); // Our scraping tools\n// Axios is a promised-based http library, similar to jQuery's Ajax method\n// It works on the client and on the server\n// Require all models\n\n\nvar db = require(\"./models\");\n\nvar PORT = 3001; // Initialize Express\n\nvar app = express(); // Configure middleware\n// Use morgan logger for logging requests\n\napp.use(logger(\"dev\")); // Parse request body as JSON\n\napp.use(express.urlencoded({\n  extended: true\n}));\napp.use(express.json()); // Make public a static folder\n\napp.use(express.static(\"public\")); // Connect to the database before starting the application server.\n\nvar MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost/bandsintown';\nmongoose.connect(MONGODB_URI, {\n  useNewUrlParser: true\n});\nmongoose.connection.once('open', function () {\n  console.log('Database connection has been made');\n}).on('error', function (error) {\n  console.log('Database error:', error);\n});\n\nfunction getBandData() {\n  var cheerio = require(\"cheerio\");\n\n  var axios = require(\"axios\"); // First, tell the console what server.js is doing\n\n\n  console.log(\"\\n***********************************\\n\" + \"Grabbing Top 18 bands playing\\n\" + \"in 'this location':\" + \"\\n***********************************\\n\"); // Making a request via axios for reddit's \"webdev\" board. We are sure to use old.reddit due to changes in HTML structure for the new reddit. The page's Response is passed as our promise argument.\n  //axios.get(\"https://www.bandsintown.com/?place_id=ChIJzWXFYYuifDUR64Pq5LTtioU&sort_by_filter=Number+of+RSVPs\").then(function(response) {\n\n  var BASEURL = \"https://www.bandsintown.com/?latitude=\";\n  var LAT = \"36.16\";\n  var LON = \"-86.77\";\n  var SORT = \"&sort_by_filter=Number+of+RSVPs\";\n  var url = BASEURL + LAT + \"&\" + LON + SORT;\n  axios.get(url).then(function (response) {\n    // Load the Response into cheerio and save it to a variable\n    // '$' becomes a shorthand for cheerio's selector commands, much like jQuery's '$'\n    var $ = cheerio.load(response.data); // An empty array to  save the data that we'll scrape\n\n    var results = []; // With cheerio, find each p-tag with the \"title\" class\n    // (i: iterator. element: the current element)\n\n    $(\"div.upcomingEvents-075e0336\").each(function (i, element) {\n      // Save the text of the element in a \"title\" variable\n      var title = $(element).text();\n      var eventsNear = $(element).find(\"h1\").text();\n      $(element).find(\"h2.event-5daafce9\").each(function (i, element) {\n        var bandName = $(element).text(); // In the currently selected element, look at its child elements (i.e., its a-tags),\n        // then save the values for any \"href\" attributes that the child elements may have\n        // Save these results in an object that we'll push into the results array we defined earlier\n\n        results.push({\n          //title: title,\n          //City: eventsNear,\n          bandName: bandName\n        });\n      });\n      db.Bands.create(results).then(function (dbBands) {\n        console.log(dbBands);\n      }).catch(function (err) {\n        console.log(err);\n      });\n    });\n    app.get(\"/bands\", function (req, res) {\n      db.Bands.find({}).then(function (dbArticle) {\n        res.json(dbBands);\n      }).catch(function (err) {\n        res.json(err);\n      });\n    }); // Log the results once you've looped through each of the elements found with cheerio\n\n    console.log(results);\n  });\n} // Start the server\n\n\napp.listen(PORT, function () {\n  console.log(\"App running on port \" + PORT + \"!\");\n});\ngetBandData();\nmodule.exports = getBandData;","map":null,"metadata":{},"sourceType":"script"}